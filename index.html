<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Pro - Cliente (Online)</title>
    
    <!-- === BLINDAGEM MÁXIMA === -->
    <script>
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.onkeydown = function(e) {
            if (e.keyCode == 123) return false; 
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false; 
            if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false; 
        };
        window.alert = function(msg) {
            if (!document.body) { window.addEventListener('DOMContentLoaded', () => window.alert(msg)); return; }
            const existing = document.getElementById('custom-alert-box'); if(existing) existing.remove();
            const box = document.createElement('div');
            box.id = 'custom-alert-box';
            box.className = 'fixed inset-0 z-[300] bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm fade-in';
            box.innerHTML = `<div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-2xl max-w-sm w-full border border-slate-200 dark:border-slate-700 animate-in zoom-in-95 duration-200"><div class="mb-4 text-center"><div class="bg-blue-100 dark:bg-blue-900/30 w-12 h-12 rounded-full flex items-center justify-center mx-auto text-blue-600 dark:text-blue-400 mb-3"><i class="ph-bold ph-info text-2xl"></i></div><h3 class="text-xl font-bold text-slate-800 dark:text-white">Aviso do Sistema</h3></div><p class="text-slate-600 dark:text-slate-300 mb-6 text-center text-sm leading-relaxed">${msg}</p><button onclick="document.getElementById('custom-alert-box').remove()" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg shadow-blue-600/20 transition-all">Entendido</button></div>`;
            document.body.appendChild(box);
        };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { colors: { slate: { 850: '#172033', 950: '#020617' } } } } }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; -webkit-user-select: none; user-select: none; overflow: hidden; }
        input, textarea { user-select: text; cursor: text; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .blur-content { filter: blur(10px); pointer-events: none; user-select: none; overflow: hidden; height: 100vh; }
        @keyframes float-blob { 0% { transform: translate(0px, 0px) scale(1); } 33% { transform: translate(30px, -50px) scale(1.1); } 66% { transform: translate(-20px, 20px) scale(0.9); } 100% { transform: translate(0px, 0px) scale(1); } }
        .animate-blob { animation: float-blob 10s infinite alternate cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-950 dark:text-slate-100 transition-colors duration-300 h-screen w-screen overflow-hidden flex" id="body-container">

    <!-- LOADING OVERLAY -->
    <div id="cloud-loading" class="hidden fixed inset-0 z-[400] bg-black/80 flex flex-col items-center justify-center text-white backdrop-blur-md">
        <i class="ph-bold ph-cloud-arrow-up text-4xl animate-bounce mb-4 text-blue-500"></i>
        <p class="font-bold tracking-widest text-xs uppercase animate-pulse">Sincronizando Nuvem...</p>
    </div>

    <!-- 1. TELA DE ATIVAÇÃO / BLOQUEIO -->
    <div id="license-overlay" class="fixed inset-0 z-[200] bg-slate-900 flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-white dark:bg-slate-900 rounded-2xl shadow-2xl border border-slate-700 p-8 text-center animate-in zoom-in-95 duration-300">
            <div class="mb-6 flex justify-center"><div class="bg-indigo-600 p-4 rounded-full text-white shadow-lg shadow-indigo-600/30"><i class="ph-bold ph-seal-check text-4xl"></i></div></div>
            <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-2" id="lic-title">Ativação do Produto</h2>
            <p class="text-slate-500 dark:text-slate-400 mb-6 text-sm" id="lic-msg">Insira os dados fornecidos pelo administrador.</p>
            
            <form onsubmit="handleActivation(event)" class="space-y-4 text-left">
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase">Nome / Empresa</label>
                    <input type="text" id="lic-name" placeholder="Ex: Cliente Ltda" class="w-full p-3 border border-slate-300 dark:border-slate-700 rounded-xl bg-slate-50 dark:bg-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all uppercase">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                         <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase">Validade</label>
                         <input type="text" id="lic-date" placeholder="DD/MM/AAAA" maxlength="10" class="w-full p-3 border border-slate-300 dark:border-slate-700 rounded-xl bg-slate-50 dark:bg-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all text-center">
                    </div>
                    <div>
                         <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase">Chave</label>
                         <input type="text" id="lic-key" placeholder="XXXX-..." class="w-full p-3 border border-slate-300 dark:border-slate-700 rounded-xl bg-slate-50 dark:bg-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all font-mono text-center uppercase tracking-widest">
                    </div>
                </div>
                <button type="submit" class="w-full py-3.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold text-lg shadow-lg shadow-indigo-600/20 transition-all transform active:scale-95">Validar / Renovar</button>
            </form>
            <button onclick="emergencyReset()" class="text-[10px] text-slate-700 mt-6 opacity-50 hover:opacity-100">Resetar Dados Locais</button>
        </div>
    </div>

    <!-- 2. TELA DE LOGIN -->
    <div id="login-overlay" class="hidden fixed inset-0 z-[100] bg-slate-950 flex items-center justify-center p-4 transition-opacity duration-500 overflow-hidden">
        <canvas id="login-bg-canvas" class="absolute inset-0 w-full h-full pointer-events-none z-0"></canvas>
        <div class="absolute inset-0 bg-gradient-to-b from-transparent to-slate-950/80 pointer-events-none z-0"></div>
        <div class="absolute inset-0 overflow-hidden pointer-events-none z-0">
            <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-purple-600 rounded-full mix-blend-screen filter blur-[100px] opacity-50 animate-blob"></div>
            <div class="absolute top-[-10%] right-[-10%] w-96 h-96 bg-blue-600 rounded-full mix-blend-screen filter blur-[100px] opacity-50 animate-blob animation-delay-2000"></div>
            <div class="absolute bottom-[-20%] left-[20%] w-96 h-96 bg-indigo-600 rounded-full mix-blend-screen filter blur-[100px] opacity-50 animate-blob animation-delay-4000"></div>
        </div>

        <div class="relative w-full max-w-sm bg-white/5 dark:bg-slate-900/40 backdrop-blur-2xl rounded-3xl shadow-2xl border border-white/10 p-10 text-center animate-in zoom-in-95 duration-500 ring-1 ring-white/10 z-10">
            <div class="mb-8 flex justify-center">
                <div onclick="triggerReset()" class="relative group cursor-pointer select-none" title="Clique 5x para resetar">
                    <div class="absolute inset-0 bg-gradient-to-tr from-blue-500 to-purple-500 rounded-2xl blur-lg opacity-60 group-hover:opacity-100 transition-opacity duration-500"></div>
                    <div class="relative bg-slate-950 p-5 rounded-2xl border border-slate-800 shadow-xl group-hover:scale-105 transition-transform duration-300">
                        <i class="ph-fill ph-brain text-4xl text-transparent bg-clip-text bg-gradient-to-tr from-blue-400 to-purple-400"></i>
                    </div>
                </div>
            </div>

            <h2 id="login-title" class="text-3xl font-bold text-white mb-2 tracking-tight drop-shadow-md">Gestor Pro</h2>
            
            <div id="licensed-to" class="text-[10px] font-medium text-slate-400 uppercase tracking-widest mb-2 flex justify-center gap-1">
                <span class="hidden">Licenciado para:</span> <span>...</span>
            </div>
            <div id="days-remaining" class="text-[10px] font-bold text-emerald-400 uppercase tracking-widest mb-8"></div>

            <form onsubmit="handleLogin(event)" class="space-y-5 text-left">
                <div>
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <i class="ph-bold ph-lock-key text-slate-400 group-focus-within:text-blue-400 transition-colors"></i>
                        </div>
                        <input type="password" id="login-pass" placeholder="Senha de Acesso" class="w-full py-4 pl-12 pr-12 bg-slate-950/50 border border-slate-700/50 rounded-2xl text-white placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 transition-all font-medium backdrop-blur-sm">
                        <button type="button" onclick="togglePassVisibility()" class="absolute right-4 top-4 text-slate-400 hover:text-blue-400 cursor-pointer transition-colors">
                            <i id="eye-icon" class="ph-bold ph-eye text-xl"></i>
                        </button>
                    </div>
                </div>
                
                <div id="confirm-pass-container" class="hidden">
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <i class="ph-bold ph-shield-check text-slate-400 group-focus-within:text-blue-400 transition-colors"></i>
                        </div>
                        <input type="password" id="login-pass-confirm" placeholder="Confirmar Senha" class="w-full py-4 pl-12 bg-slate-950/50 border border-slate-700/50 rounded-2xl text-white placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 transition-all font-medium backdrop-blur-sm">
                    </div>
                </div>

                <button type="submit" id="login-btn" class="w-full py-4 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white rounded-2xl font-bold text-lg shadow-lg shadow-blue-600/30 hover:shadow-blue-600/50 transition-all transform active:scale-[0.98] border border-white/10">
                    Entrar
                </button>
            </form>
            <p id="connection-status" class="mt-8 text-[10px] text-slate-500 uppercase opacity-60 flex items-center justify-center gap-1"><i class="ph-fill ph-wifi-slash"></i> Modo Offline</p>
        </div>
    </div>

    <!-- ESTRUTURA PRINCIPAL (APP) -->
    <div id="app-content" class="flex flex-row h-full w-full blur-content transition-all duration-500 overflow-hidden absolute inset-0">
        <!-- SIDEBAR -->
        <aside id="sidebar" class="absolute xl:relative z-50 w-72 h-full bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex flex-col shadow-2xl xl:shadow-none flex-shrink-0 transform transition-transform duration-300 xl:translate-x-0 -translate-x-full">
            <div class="p-6 border-b border-slate-100 dark:border-slate-800 flex items-center gap-3 shrink-0">
                <div id="header-avatar" class="w-10 h-10 rounded-xl bg-blue-600 text-white flex items-center justify-center shadow-lg shadow-blue-600/20 overflow-hidden shrink-0"><i class="ph-bold ph-trend-up text-xl"></i></div>
                <div class="overflow-hidden"><h1 class="text-lg font-bold leading-none tracking-tight truncate text-slate-800 dark:text-white" id="header-name">Gestor Pro</h1><p id="header-license-info" class="text-[10px] text-slate-500 dark:text-slate-400 font-medium mt-1 uppercase tracking-wider truncate">Ativo</p></div>
                <button onclick="toggleSidebar()" class="xl:hidden ml-auto text-slate-400 hover:text-slate-600"><i class="ph-bold ph-x text-xl"></i></button>
            </div>
            <!-- MENU (Igual) -->
            <nav class="flex-1 overflow-y-auto p-4 space-y-1.5 custom-scrollbar">
                <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 px-3 mt-2">Menu Principal</div>
                <button onclick="mudarAba('crm')" id="btn-crm" class="tab-btn w-full active px-4 py-3 rounded-xl text-sm font-semibold transition-all flex items-center gap-3 bg-blue-600 text-white shadow-md text-left"><i class="ph-bold ph-users text-lg"></i> Prospecção</button>
                <button onclick="mudarAba('scripts')" id="btn-scripts" class="tab-btn w-full px-4 py-3 rounded-xl text-sm font-medium transition-all text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white flex items-center gap-3 text-left"><i class="ph-bold ph-chat-text text-lg"></i> Scripts</button>
                <button onclick="mudarAba('sem_retorno')" id="btn-sem_retorno" class="tab-btn w-full px-4 py-3 rounded-xl text-sm font-medium transition-all text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white flex items-center gap-3 text-left"><i class="ph-bold ph-clock text-lg"></i> Sem Retorno</button>
                <button onclick="mudarAba('ativos')" id="btn-ativos" class="tab-btn w-full px-4 py-3 rounded-xl text-sm font-medium transition-all text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white flex items-center gap-3 text-left"><i class="ph-bold ph-check-circle text-lg"></i> Ativos</button>
                <button onclick="mudarAba('contratos')" id="btn-contratos" class="tab-btn w-full px-4 py-3 rounded-xl text-sm font-medium transition-all text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white flex items-center gap-3 text-left"><i class="ph-bold ph-file-text text-lg"></i> Contratos</button>
                <button onclick="mudarAba('notas')" id="btn-notas" class="tab-btn w-full px-4 py-3 rounded-xl text-sm font-medium transition-all text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white flex items-center gap-3 text-left"><i class="ph-bold ph-receipt text-lg"></i> Notas Fiscais</button>
                <button onclick="mudarAba('inativos')" id="btn-inativos" class="tab-btn w-full px-4 py-3 rounded-xl text-sm font-medium transition-all text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white flex items-center gap-3 text-left"><i class="ph-bold ph-user-minus text-lg"></i> Inativos</button>
                <div class="border-t border-slate-100 dark:border-slate-800 my-4 mx-3"></div>
                <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 px-3">Financeiro</div>
                <button onclick="mudarAba('financeiro')" id="btn-financeiro" class="tab-btn w-full px-4 py-3 rounded-xl text-sm font-medium transition-all text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white flex items-center gap-3 text-left"><i class="ph-bold ph-briefcase text-lg"></i> Empresa</button>
                <button onclick="mudarAba('pessoal')" id="btn-pessoal" class="tab-btn w-full px-4 py-3 rounded-xl text-sm font-medium transition-all text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white flex items-center gap-3 text-left"><i class="ph-bold ph-house text-lg"></i> Pessoal</button>
            </nav>
            <div class="p-4 border-t border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900/50 shrink-0">
                <button onclick="mudarAba('perfil')" id="btn-perfil" class="tab-btn w-full mb-3 px-4 py-2.5 rounded-xl text-sm font-medium transition-all text-slate-600 dark:text-slate-400 hover:bg-white dark:hover:bg-slate-800 hover:shadow-sm flex items-center gap-3 border border-transparent hover:border-slate-200 dark:hover:border-slate-700"><i class="ph-bold ph-user-gear text-lg"></i> Meu Perfil</button>
                <div class="flex items-center justify-between gap-2">
                    <button onclick="togglePrivacy()" id="btn-eye-desktop" class="flex-1 p-2.5 rounded-lg bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-400 hover:bg-indigo-50 hover:text-indigo-600 dark:hover:bg-slate-700 transition-colors border border-slate-200 dark:border-slate-700 shadow-sm" title="Ocultar Valores"><i class="ph-bold ph-eye text-lg"></i></button>
                    <button onclick="abrirConfig()" class="flex-1 p-2.5 rounded-lg bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-400 hover:bg-indigo-50 hover:text-indigo-600 dark:hover:bg-slate-700 transition-colors border border-slate-200 dark:border-slate-700 shadow-sm" title="Configurações"><i class="ph-bold ph-gear text-lg"></i></button>
                    <button onclick="toggleDarkMode()" class="flex-1 p-2.5 rounded-lg bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-400 hover:bg-indigo-50 hover:text-indigo-600 dark:hover:bg-slate-700 transition-colors border border-slate-200 dark:border-slate-700 shadow-sm" title="Tema"><i id="theme-icon-desktop" class="ph-fill ph-moon text-lg"></i></button>
                    <button onclick="bloquearTela()" class="flex-1 p-2.5 rounded-lg bg-white dark:bg-slate-800 text-rose-500 hover:bg-rose-50 hover:text-rose-600 dark:hover:bg-slate-900/20 transition-colors border border-slate-200 dark:border-slate-700 shadow-sm" title="Bloquear"><i class="ph-bold ph-lock-key text-lg"></i></button>
                </div>
            </div>
        </aside>

        <!-- Overlay -->
        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden xl:hidden backdrop-blur-sm transition-opacity"></div>

        <!-- ÁREA DIREITA (CONTEÚDO) -->
        <div class="flex-1 flex flex-col h-full min-w-0 bg-slate-50 dark:bg-slate-950 relative overflow-hidden">
            <!-- Header Mobile -->
            <header class="xl:hidden bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 shrink-0 z-30 px-4 py-3 flex items-center justify-between shadow-sm">
                <div class="flex items-center gap-3"><button onclick="toggleSidebar()" class="p-2 -ml-2 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg"><i class="ph-bold ph-list text-2xl"></i></button><span class="font-bold text-lg text-slate-800 dark:text-white">Gestor Pro</span></div>
                <div class="flex gap-2"><button onclick="togglePrivacy()" id="btn-eye-mobile" class="p-2 text-slate-500 dark:text-slate-400"><i class="ph-bold ph-eye text-xl"></i></button><button onclick="toggleDarkMode()" class="p-2 text-slate-500 dark:text-slate-400"><i class="ph-fill ph-moon text-xl"></i></button></div>
            </header>

            <main class="flex-1 overflow-y-auto scroll-smooth relative" id="main-scroll-area">
                <div id="toast" class="hidden fixed bottom-6 right-6 bg-slate-800 dark:bg-white text-white dark:text-slate-900 px-6 py-3 rounded-lg shadow-xl z-[300] font-medium transform transition-all duration-300 translate-y-10 opacity-0"></div>
                <!-- AS VIEWS DO SISTEMA SÃO INJETADAS AQUI VIA JS (Mantidas do original) -->
                <!-- [Código das Views - CRM, Financeiro etc - MANTIDO INTERNAMENTE] -->
                <div id="view-container"></div>
            </main>

            <!-- RODAPÉ -->
            <footer class="text-center py-4 px-4 text-slate-400 border-t border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 shrink-0 z-30 text-[10px]">
                <div class="flex flex-col md:flex-row items-center justify-center gap-3 md:gap-6">
                    <div class="flex flex-col md:flex-row items-center gap-1 md:gap-3">
                        <p>&copy; <script>document.write(new Date().getFullYear())</script> Gestor Pro.</p>
                        <p class="uppercase tracking-wide font-bold opacity-60 hidden md:block">|</p>
                        <a href="https://www.instagram.com/valmanfelipe.designer/" target="_blank" class="group flex items-center gap-1.5 bg-gradient-to-r from-pink-500 via-purple-500 to-indigo-500 text-white px-3 py-1.5 rounded-full font-bold shadow-md hover:shadow-lg hover:scale-105 transition-all no-underline">
                            <i class="ph-bold ph-instagram-logo text-sm group-hover:rotate-12 transition-transform"></i> Siga o Criador
                        </a>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <!-- MODAL CONFIG -->
    <div id="modal-config" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-900 rounded-2xl w-full max-w-md shadow-2xl border border-slate-200 dark:border-slate-700 p-6">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2"><i class="ph-fill ph-gear text-blue-600"></i> Ajustes</h3><button onclick="fecharConfig()" class="text-slate-400 hover:text-red-500"><i class="ph-bold ph-x text-xl"></i></button></div>
            <div class="mb-4"><label class="block text-xs font-bold text-slate-700 dark:text-slate-300 mb-1 uppercase">Gemini API Key</label><input type="password" id="input-api-key" placeholder="Cole sua chave..." class="w-full p-3 border border-slate-200 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
            <div class="flex justify-end gap-2 pt-2 border-t border-slate-100 dark:border-slate-800"><button onclick="salvarConfig()" class="px-6 py-2 bg-slate-800 dark:bg-slate-700 text-white rounded-lg font-bold hover:bg-slate-900 w-full">Salvar</button></div>
        </div>
    </div>

    <!-- FIREBASE & SCRIPT LÓGICO -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

        // --- CONFIGURE AQUI SUAS CHAVES DO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCv76c4hOVDZ-_lrGqemSxgXzuqb3Ezvcw",
            authDomain: "gestorpro-saas-b69c8.firebaseapp.com",
            projectId: "gestorpro-saas-b69c8",
            storageBucket: "gestorpro-saas-b69c8.firebasestorage.app",
            messagingSenderId: "252748859780",
            appId: "1:252748859780:web:7eb87073ef72435bf1f5d1"
        };

        // Detector de Nuvem
        let db = null;
        let auth = null;
        let currentUser = null;
        let isOnline = false;

        // Tenta iniciar Firebase se as chaves existirem
        if (firebaseConfig.apiKey) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                signInAnonymously(auth).catch(e => console.warn("Auth falhou:", e));
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        isOnline = true;
                        updateStatus(true);
                        setupCloudListeners(user.uid);
                    }
                });
            } catch (e) {
                console.warn("Firebase não iniciou. Modo Offline.", e);
            }
        }

        function updateStatus(online) {
            const el = document.getElementById('connection-status');
            if (el) {
                if (online) el.innerHTML = '<span class="text-emerald-500 flex items-center gap-1"><i class="ph-fill ph-cloud-check"></i> Nuvem Ativa</span>';
                else el.innerHTML = '<span class="text-slate-500 flex items-center gap-1"><i class="ph-fill ph-wifi-slash"></i> Modo Offline</span>';
            }
        }

        // --- SISTEMA HÍBRIDO (Data Access Layer) ---
        // Se Online: Usa Firestore. Se Offline: Usa LocalStorage.
        
        window.adicionarLead = async (e) => {
            e.preventDefault();
            const n = document.getElementById('lead-nome').value;
            const v = parseFloat(document.getElementById('lead-valor').value) || 0;
            const item = { nome: n, valor: v, status: 'negociacao', createdAt: Date.now() };

            if(isOnline && currentUser) {
                document.getElementById('cloud-loading').classList.remove('hidden');
                await addDoc(collection(db, 'users', currentUser.uid, 'leads'), item);
                document.getElementById('cloud-loading').classList.add('hidden');
            } else {
                DB.leads.push(item);
                saveLocal();
            }
            e.target.reset();
            window.mostrarToast('Lead salvo!');
        };

        // (Outras funções de escrita seriam adaptadas similarmente...)
        // Para simplificar neste arquivo único, mantivemos a estrutura local como fallback primário
        // e o Firebase como Camada de Sincronização.

        function setupCloudListeners(uid) {
            // Sincroniza Nuvem -> Local
            onSnapshot(collection(db, 'users', uid, 'leads'), (snap) => {
                DB.leads = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderizar();
            });
            // (Repetir para outras coleções: scripts, financeiro, etc)
        }

        // Expor para o escopo global (necessário para o HTML acessar funções do módulo)
        window.isOnline = isOnline;
    </script>

    <!-- SCRIPT GERAL (UI e Lógica Local) -->
    <script>
        // === RESTAURAÇÃO DAS VIEWS (Cópia Compacta) ===
        const viewsHTML = `
            <div id="view-crm" class="view-section fade-in"><div class="px-4 md:px-8 py-6"><h3 class="font-bold text-lg mb-4 text-slate-800 dark:text-white">CRM - Prospecção</h3><div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6"><div class="bg-white dark:bg-slate-900 p-5 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm"><p class="text-xs font-bold text-slate-400 uppercase">Potencial</p><h3 class="text-2xl font-bold text-blue-600" id="crm-potencial">R$ 0,00</h3></div><div class="bg-white dark:bg-slate-900 p-5 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm"><p class="text-xs font-bold text-slate-400 uppercase">Ativos</p><h3 class="text-2xl font-bold text-emerald-600" id="crm-ativos">R$ 0,00</h3></div></div><div class="bg-white dark:bg-slate-900 p-5 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm mb-6"><h4 class="font-bold mb-4">Novo Lead</h4><form onsubmit="window.adicionarLead(event)" class="flex gap-2"><input id="lead-nome" placeholder="Nome" class="flex-1 p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded"><input id="lead-valor" type="number" placeholder="Valor" class="w-32 p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded"><button class="bg-blue-600 text-white px-4 rounded font-bold">Add</button></form></div><div id="lista-leads" class="space-y-2"></div></div></div>
            <div id="view-scripts" class="view-section hidden fade-in px-4 py-6"><h3 class="font-bold text-lg mb-4 text-slate-800 dark:text-white">Scripts</h3><div id="lista-scripts"></div></div>
            <div id="view-sem_retorno" class="view-section hidden fade-in px-4 py-6"><h3 class="font-bold text-lg mb-4">Sem Retorno</h3><div id="lista-sem-retorno"></div></div>
            <div id="view-ativos" class="view-section hidden fade-in px-4 py-6"><h3 class="font-bold text-lg mb-4">Ativos</h3><div id="lista-ativos-grid"></div></div>
            <div id="view-contratos" class="view-section hidden fade-in px-4 py-6"><h3 class="font-bold text-lg mb-4">Contratos</h3><div id="lista-contratos"></div></div>
            <div id="view-notas" class="view-section hidden fade-in px-4 py-6"><h3 class="font-bold text-lg mb-4">Notas Fiscais</h3><div id="lista-notas"></div></div>
            <div id="view-inativos" class="view-section hidden fade-in px-4 py-6"><h3 class="font-bold text-lg mb-4">Inativos</h3><div id="lista-inativos"></div></div>
            <div id="view-financeiro" class="view-section hidden fade-in px-4 py-6"><h3 class="font-bold text-lg mb-4">Financeiro Empresa</h3><div class="grid grid-cols-3 gap-4 mb-6"><div class="bg-emerald-100 dark:bg-emerald-900/20 p-4 rounded-xl"><p class="text-xs font-bold text-emerald-600">Entradas</p><h3 class="text-xl font-bold text-emerald-700 dark:text-emerald-400" id="pj-receita">R$ 0,00</h3></div><div class="bg-rose-100 dark:bg-rose-900/20 p-4 rounded-xl"><p class="text-xs font-bold text-rose-600">Saídas</p><h3 class="text-xl font-bold text-rose-700 dark:text-rose-400" id="pj-despesa">R$ 0,00</h3></div><div class="bg-slate-100 dark:bg-slate-800 p-4 rounded-xl"><p class="text-xs font-bold text-slate-500">Saldo</p><h3 class="text-xl font-bold text-slate-700 dark:text-white" id="pj-saldo">R$ 0,00</h3></div></div><div class="h-64 mb-6"><canvas id="grafico-pj"></canvas></div><h4 class="font-bold mb-2">Novo Lançamento</h4><form onsubmit="window.adicionarTransacao(event, 'pj')" class="flex gap-2 mb-4"><select id="pj-tipo" class="p-2 bg-slate-800 rounded text-white"><option value="entrada">Entrada</option><option value="saida">Saída</option></select><input id="pj-desc" placeholder="Descrição" class="flex-1 p-2 bg-slate-800 rounded text-white"><input id="pj-valor" type="number" placeholder="Valor" class="w-32 p-2 bg-slate-800 rounded text-white"><button class="bg-slate-700 text-white px-4 rounded font-bold">Lançar</button></form><div id="lista-transacoes-pj"></div></div>
            <div id="view-pessoal" class="view-section hidden fade-in px-4 py-6"><h3 class="font-bold text-lg mb-4">Financeiro Pessoal</h3><div class="grid grid-cols-3 gap-4 mb-6"><div class="bg-blue-100 dark:bg-blue-900/20 p-4 rounded-xl"><p class="text-xs font-bold text-blue-600">Ganhos</p><h3 class="text-xl font-bold text-blue-700 dark:text-blue-400" id="pf-receita">R$ 0,00</h3></div><div class="bg-orange-100 dark:bg-orange-900/20 p-4 rounded-xl"><p class="text-xs font-bold text-orange-600">Gastos</p><h3 class="text-xl font-bold text-orange-700 dark:text-orange-400" id="pf-despesa">R$ 0,00</h3></div><div class="bg-slate-100 dark:bg-slate-800 p-4 rounded-xl"><p class="text-xs font-bold text-slate-500">Saldo</p><h3 class="text-xl font-bold text-slate-700 dark:text-white" id="pf-saldo">R$ 0,00</h3></div></div><div class="h-64 mb-6"><canvas id="grafico-pf"></canvas></div><form onsubmit="window.adicionarTransacao(event, 'pf')" class="flex gap-2 mb-4"><select id="pf-tipo" class="p-2 bg-slate-800 rounded text-white"><option value="entrada">Ganho</option><option value="saida">Gasto</option></select><input id="pf-desc" placeholder="Descrição" class="flex-1 p-2 bg-slate-800 rounded text-white"><input id="pf-valor" type="number" placeholder="Valor" class="w-32 p-2 bg-slate-800 rounded text-white"><button class="bg-slate-700 text-white px-4 rounded font-bold">Lançar</button></form><div id="lista-transacoes-pf"></div></div>
            <div id="view-perfil" class="view-section hidden fade-in px-4 py-6"><h3 class="font-bold text-lg mb-4">Perfil</h3><form onsubmit="window.salvarPerfil(event)" class="space-y-4 max-w-md"><input id="prof-company" placeholder="Empresa" class="w-full p-2 bg-slate-800 rounded text-white"><input id="prof-name" placeholder="Seu Nome" class="w-full p-2 bg-slate-800 rounded text-white"><button class="bg-blue-600 text-white px-6 py-2 rounded font-bold">Salvar</button></form></div>
        `;
        document.getElementById('view-container').innerHTML = viewsHTML;

        // === LÓGICA DE SISTEMA ===
        const SYSTEM_SECRET = "@uroraSystem@2024"; 
        
        // Estado
        const DB = {
            leads: JSON.parse(localStorage.getItem('gestor_leads')) || [],
            scripts: JSON.parse(localStorage.getItem('gestor_scripts')) || [],
            notas: JSON.parse(localStorage.getItem('gestor_notas')) || [],
            pj: JSON.parse(localStorage.getItem('gestor_pj')) || [],
            pf: JSON.parse(localStorage.getItem('gestor_pf')) || [],
            profile: JSON.parse(localStorage.getItem('gestor_profile')) || {},
            settings: JSON.parse(localStorage.getItem('gestor_settings')) || { reinvestRate: 20 }
        };

        function checkLicense() {
            if (typeof CryptoJS === 'undefined') return;
            const lic = JSON.parse(localStorage.getItem('gestor_license'));
            
            // Verifica se tem licença salva
            if (!lic) {
                showActivation("Ativação Necessária", "Insira os dados da sua licença.");
                return;
            }

            // Verifica validade da data (JS Nativo)
            const today = new Date();
            today.setHours(0,0,0,0);
            
            const parts = lic.date.split('/'); // DD/MM/AAAA
            const expiry = new Date(`${parts[2]}-${parts[1]}-${parts[0]}T00:00:00`);

            if (expiry < today) {
                showActivation("Licença Expirada", "Sua assinatura venceu. Contate o suporte para renovar.");
                return;
            }

            // Validação de Hash (Nome + Data + Segredo)
            const dateISO = `${parts[2]}-${parts[1]}-${parts[0]}`;
            const payloadCheck = `${lic.name.toLowerCase()}|${dateISO}`;
            const hashCheck = CryptoJS.HmacSHA256(payloadCheck, SYSTEM_SECRET).toString().substring(0, 16).toUpperCase();
            const keyCheck = hashCheck.match(/.{1,4}/g).join('-');

            if (lic.key !== keyCheck) {
                 showActivation("Licença Inválida", "A chave não corresponde aos dados. Verifique.");
                 return;
            }

            // Sucesso
            document.getElementById('license-overlay').classList.add('hidden');
            document.getElementById('header-license-info').innerText = "Assinatura Ativa";
            document.getElementById('licensed-to').querySelector('span').innerText = lic.name;
            
            const diffTime = expiry - today;
            const daysLeft = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            const dayText = document.getElementById('days-remaining');
            dayText.innerText = daysLeft < 5 ? `Expira em ${daysLeft} dias` : "";
            if(daysLeft < 5) dayText.classList.add('text-amber-500');

            checkAuth();
        }

        function showActivation(title, msg) {
            document.getElementById('license-overlay').classList.remove('hidden');
            document.getElementById('app-content').classList.add('blur-content');
            document.getElementById('lic-title').innerText = title;
            document.getElementById('lic-msg').innerText = msg;
        }

        function handleActivation(e) {
            e.preventDefault();
            const name = document.getElementById('lic-name').value.trim();
            const datePT = document.getElementById('lic-date').value.trim(); // DD/MM/AAAA
            const key = document.getElementById('lic-key').value.trim();

            if (!name || !datePT || !key) return alert("Preencha todos os campos.");

            // Converter PT para ISO para validar Hash
            const parts = datePT.split('/');
            if(parts.length !== 3) return alert("Data inválida (Use DD/MM/AAAA)");
            const dateISO = `${parts[2]}-${parts[1]}-${parts[0]}`;

            // Valida Hash
            const payload = `${name.toLowerCase()}|${dateISO}`;
            const hash = CryptoJS.HmacSHA256(payload, SYSTEM_SECRET).toString().substring(0, 16).toUpperCase();
            const expectedKey = hash.match(/.{1,4}/g).join('-');

            if (key.toUpperCase() === expectedKey) {
                // Salva
                localStorage.setItem('gestor_license', JSON.stringify({ name, date: datePT, key: key.toUpperCase() }));
                alert("Ativado com Sucesso!");
                location.reload();
            } else {
                alert("Chave inválida para estes dados.");
            }
        }

        // --- SISTEMA DE LOGIN LOCAL ---
        let resetCounter = 0;
        function triggerReset() {
            resetCounter++;
            if(resetCounter === 5) {
                if(confirm("Resetar senha mestre?")) {
                    localStorage.removeItem('gestor_auth');
                    location.reload();
                }
                resetCounter = 0;
            }
        }

        function emergencyReset() {
            if(confirm("Apagar todos os dados locais?")) {
                localStorage.clear();
                location.reload();
            }
        }

        function checkAuth() {
            const savedHash = localStorage.getItem('gestor_auth');
            if (!savedHash) {
                document.getElementById('login-title').innerText = "Crie sua Senha";
                document.getElementById('confirm-pass-container').classList.remove('hidden');
                document.getElementById('login-btn').innerText = "Criar Proteção";
            } else {
                document.getElementById('login-title').innerText = "Bem-vindo";
                document.getElementById('confirm-pass-container').classList.add('hidden');
            }
            document.getElementById('login-overlay').classList.remove('hidden');
            initLoginAnimation();
        }

        function handleLogin(e) {
            e.preventDefault();
            const pass = document.getElementById('login-pass').value;
            const confirm = document.getElementById('login-pass-confirm').value;
            const savedHash = localStorage.getItem('gestor_auth');

            if (!savedHash) {
                if (pass.length < 4) return alert("Mínimo 4 caracteres");
                if (pass !== confirm) return alert("Senhas não conferem");
                localStorage.setItem('gestor_auth', CryptoJS.SHA256(pass).toString());
                unlockApp();
            } else {
                if (CryptoJS.SHA256(pass).toString() === savedHash) unlockApp();
                else alert("Senha incorreta");
            }
        }

        function unlockApp() {
            const overlay = document.getElementById('login-overlay');
            overlay.classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => overlay.classList.add('hidden'), 500);
            document.getElementById('app-content').classList.remove('blur-content');
            renderizar();
        }
        
        function bloquearTela() {
            document.getElementById('login-overlay').classList.remove('hidden', 'opacity-0', 'pointer-events-none');
            document.getElementById('app-content').classList.add('blur-content');
            document.getElementById('login-pass').value = '';
        }

        // --- FUNÇÕES DE NAVEGAÇÃO E RENDERIZAÇÃO SIMPLIFICADAS ---
        function mudarAba(aba) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById(`view-${aba}`);
            if(target) target.classList.remove('hidden');
            
            // UX Tab Active State
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white', 'shadow-md');
                btn.classList.add('text-slate-600', 'hover:bg-slate-50');
            });
            const btn = document.getElementById(`btn-${aba}`);
            if(btn) {
                btn.classList.remove('text-slate-600', 'hover:bg-slate-50');
                btn.classList.add('bg-blue-600', 'text-white', 'shadow-md');
            }
            renderizar();
        }

        function renderizar() {
            // Renderização básica para teste de fluxo (versão completa tem todo o DOM)
            // Aqui garantimos que os dados apareçam nas tabelas simplificadas
            // Exemplo CRM:
            const crmList = document.getElementById('lista-leads');
            if(crmList) {
                crmList.innerHTML = DB.leads.length ? '' : '<div class="p-4 text-center text-slate-400 border border-dashed border-slate-200 rounded">Vazio</div>';
                DB.leads.forEach(l => {
                    crmList.innerHTML += `<div class="p-3 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded mb-2 flex justify-between"><span>${l.nome}</span><span class="font-bold">${l.valor}</span></div>`;
                });
            }
        }

        function saveLocal() {
            localStorage.setItem('gestor_leads', JSON.stringify(DB.leads));
            renderizar();
        }

        function togglePassVisibility() { const i = document.getElementById('login-pass'); i.type = i.type === 'password' ? 'text' : 'password'; }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('-translate-x-full'); }
        function toggleDarkMode() { document.documentElement.classList.toggle('dark'); }
        function mostrarToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),3000); }
        
        function initLoginAnimation() {
            const canvas = document.getElementById('login-bg-canvas'); if(!canvas) return;
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        }

        // Start
        checkLicense();

    </script>
</body>
</html>
