<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Pro</title>
    
    <!-- === PROTEÇÃO DO SISTEMA === -->
    <script>
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.onkeydown = function(e) {
            if (e.keyCode == 123) return false; 
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false; 
            if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false; 
        };
        window.alert = function(msg) {
            if (!document.body) { window.addEventListener('DOMContentLoaded', () => window.alert(msg)); return; }
            const existing = document.getElementById('custom-alert-box'); if(existing) existing.remove();
            const box = document.createElement('div');
            box.id = 'custom-alert-box';
            box.className = 'fixed inset-0 z-[300] bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm fade-in';
            box.innerHTML = `<div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-2xl max-w-sm w-full border border-slate-200 dark:border-slate-700 animate-in zoom-in-95 duration-200"><div class="mb-4 text-center"><div class="bg-blue-100 dark:bg-blue-900/30 w-12 h-12 rounded-full flex items-center justify-center mx-auto text-blue-600 dark:text-blue-400 mb-3"><i class="ph-bold ph-info text-2xl"></i></div><h3 class="text-xl font-bold text-slate-800 dark:text-white">Aviso do Sistema</h3></div><p class="text-slate-600 dark:text-slate-300 mb-6 text-center text-sm leading-relaxed">${msg}</p><button onclick="document.getElementById('custom-alert-box').remove()" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg shadow-blue-600/20 transition-all">Entendido</button></div>`;
            document.body.appendChild(box);
        };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { colors: { slate: { 850: '#172033', 950: '#020617' } } } } }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; -webkit-user-select: none; user-select: none; overflow: hidden; }
        input, textarea { user-select: text; cursor: text; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .blur-content { filter: blur(10px); pointer-events: none; user-select: none; overflow: hidden; height: 100vh; }
        .health-bar-container { position: relative; overflow: hidden; }
        .health-bar-fill { transition: width 1s ease-in-out, background-color 0.5s ease; }
        .check-group input:checked + div { background-color: #10b981; border-color: #10b981; color: white; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-950 dark:text-slate-100 transition-colors duration-300 h-screen w-screen overflow-hidden flex" id="body-container">

    <script>
        // Configuração Inicial do Tema
        if (localStorage.getItem('gestor_theme') === 'dark' || (!('gestor_theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        // Base de Dados Global
        window.DB = {
            leads: JSON.parse(localStorage.getItem('gestor_leads')) || [],
            scripts: JSON.parse(localStorage.getItem('gestor_scripts')) || [],
            notas: JSON.parse(localStorage.getItem('gestor_notas')) || [],
            pj: JSON.parse(localStorage.getItem('gestor_pj')) || [],
            pf: JSON.parse(localStorage.getItem('gestor_pf')) || [],
            metas: JSON.parse(localStorage.getItem('gestor_metas')) || [],
            profile: JSON.parse(localStorage.getItem('gestor_profile')) || {},
            settings: JSON.parse(localStorage.getItem('gestor_settings')) || { reinvestRate: 20 }
        };
        window.isOnline = false;
        window.showValues = localStorage.getItem('gestor_show_values') !== 'false';
        window.viewDate = new Date();
        
        window.formatMoney = function(val) {
            if (!window.showValues) return 'R$ •••••';
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val || 0);
        };

        window.togglePassVisibility = function() {
            const input = document.getElementById('login-pass');
            const icon = document.getElementById('eye-icon');
            if (input && icon) {
                if (input.type === "password") {
                    input.type = "text";
                    icon.classList.replace('ph-eye', 'ph-eye-slash');
                } else {
                    input.type = "password";
                    icon.classList.replace('ph-eye-slash', 'ph-eye');
                }
            }
        };
    </script>

    <!-- LOADING OVERLAY -->
    <div id="cloud-loading" class="hidden fixed inset-0 z-[400] bg-black/80 flex flex-col items-center justify-center text-white backdrop-blur-md">
        <i class="ph-bold ph-cloud-arrow-up text-4xl animate-bounce mb-4 text-blue-500"></i>
        <p class="font-bold tracking-widest text-xs uppercase animate-pulse">Sincronizando...</p>
    </div>

    <!-- TELA DE ATIVAÇÃO -->
    <div id="license-overlay" class="fixed inset-0 z-[200] bg-slate-900 flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-white dark:bg-slate-900 rounded-2xl shadow-2xl border border-slate-700 p-8 text-center animate-in zoom-in-95 duration-300">
            <div class="mb-6 flex justify-center"><div class="bg-indigo-600 p-4 rounded-full text-white shadow-lg shadow-indigo-600/30"><i class="ph-bold ph-seal-check text-4xl"></i></div></div>
            <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-2" id="lic-title">Ativação Necessária</h2>
            <p class="text-slate-500 dark:text-slate-400 mb-6 text-sm" id="lic-msg">Insira os seus dados de licença.</p>
            <form onsubmit="handleActivation(event)" class="space-y-4 text-left">
                <div><label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Empresa</label><input type="text" id="lic-name" class="w-full p-3 border rounded-xl dark:bg-slate-800 dark:text-white uppercase"></div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Validade</label><input type="text" id="lic-date" placeholder="DD/MM/AAAA" class="w-full p-3 border rounded-xl dark:bg-slate-800 dark:text-white text-center"></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Chave</label><input type="text" id="lic-key" class="w-full p-3 border rounded-xl dark:bg-slate-800 dark:text-white font-mono text-center uppercase tracking-widest"></div>
                </div>
                <button type="submit" class="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold">Validar Sistema</button>
            </form>
            <button onclick="emergencyReset()" class="text-[10px] text-slate-500 mt-6 opacity-50 hover:opacity-100">Resetar Dados</button>
        </div>
    </div>

    <!-- TELA DE LOGIN -->
    <div id="login-overlay" class="hidden fixed inset-0 z-[100] bg-slate-950 flex items-center justify-center p-4 transition-opacity duration-500">
        <canvas id="login-bg-canvas" class="absolute inset-0 w-full h-full pointer-events-none z-0"></canvas>
        <div class="relative w-full max-w-sm bg-white/5 backdrop-blur-2xl rounded-3xl border border-white/10 p-10 text-center animate-in zoom-in-95 duration-500 z-10">
            <div class="mb-8 flex justify-center">
                <div class="relative bg-slate-950 p-5 rounded-2xl border border-slate-800 shadow-xl">
                    <i class="ph-fill ph-brain text-4xl text-blue-400"></i>
                </div>
            </div>
            <h2 id="login-title" class="text-3xl font-bold text-white mb-2">Gestor Pro</h2>
            <div id="days-remaining" class="text-[10px] font-bold text-emerald-400 uppercase tracking-widest mb-8"></div>
            <form onsubmit="handleLogin(event)" class="space-y-5 text-left">
                <div class="relative group">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"><i class="ph-bold ph-lock-key text-slate-400"></i></div>
                    <input type="password" id="login-pass" placeholder="Sua Senha" class="w-full py-4 pl-12 pr-12 bg-slate-950/50 border border-slate-700 rounded-2xl text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="button" onclick="window.togglePassVisibility()" class="absolute right-4 top-4 text-slate-400 z-10"><i id="eye-icon" class="ph-bold ph-eye text-xl"></i></button>
                </div>
                <div id="confirm-pass-container" class="hidden"><input type="password" id="login-pass-confirm" placeholder="Confirmar Senha" class="w-full py-4 px-6 bg-slate-950/50 border border-slate-700 rounded-2xl text-white mt-3"></div>
                <button type="submit" class="w-full py-4 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-2xl font-bold text-lg">Entrar</button>
            </form>
            <p id="connection-status" class="mt-8 text-[10px] text-slate-500 uppercase flex items-center justify-center gap-1">A carregar...</p>
        </div>
    </div>

    <!-- ESTRUTURA PRINCIPAL -->
    <div id="app-content" class="flex flex-row h-full w-full blur-content transition-all duration-500 overflow-hidden absolute inset-0">
        <aside id="sidebar" class="absolute xl:relative z-50 w-72 h-full bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex flex-col transform transition-transform duration-300 xl:translate-x-0 -translate-x-full">
            <div class="p-6 border-b border-slate-100 dark:border-slate-800 flex items-center gap-3">
                <div id="header-avatar" class="w-10 h-10 rounded-xl bg-blue-600 text-white flex items-center justify-center shadow-lg"><i class="ph-bold ph-trend-up text-xl"></i></div>
                <div class="overflow-hidden"><h1 class="text-lg font-bold truncate text-slate-800 dark:text-white" id="header-name">Gestor Pro</h1><p id="header-license-info" class="text-[10px] text-emerald-500 font-bold uppercase tracking-wider">Sistema Ativo</p></div>
            </div>
            <nav class="flex-1 overflow-y-auto p-4 space-y-1.5 custom-scrollbar">
                <button onclick="mudarAba('crm')" id="btn-crm" class="tab-btn w-full active px-4 py-3 rounded-xl text-sm font-semibold flex items-center gap-3 bg-blue-600 text-white shadow-md"><i class="ph-bold ph-users text-lg"></i> Prospecção</button>
                <button onclick="mudarAba('scripts')" id="btn-scripts" class="tab-btn w-full px-4 py-3 rounded-xl text-sm font-medium flex items-center gap-3 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800"><i class="ph-bold ph-chat-text text-lg"></i> Scripts</button>
                <button onclick="mudarAba('contas')" id="btn-contas" class="tab-btn w-full px-4 py-3 rounded-xl text-sm font-medium flex items-center gap-3 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800"><i class="ph-bold ph-list-checks text-lg"></i> Controle de Contas</button>
                <button onclick="mudarAba('metas')" id="btn-metas" class="tab-btn w-full px-4 py-3 rounded-xl text-sm font-medium flex items-center gap-3 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800"><i class="ph-bold ph-target text-lg"></i> Metas</button>
                <button onclick="mudarAba('notificacoes')" id="btn-notificacoes" class="tab-btn w-full px-4 py-3 rounded-xl text-sm font-medium flex items-center gap-3 text-slate-600 dark:text-slate-400 relative">
                    <i class="ph-bold ph-bell text-lg"></i> Novidades
                    <span id="notif-badge" class="hidden absolute top-4 right-4 w-2.5 h-2.5 bg-rose-500 rounded-full border border-white animate-pulse"></span>
                </button>
                <div class="border-t border-slate-100 dark:border-slate-800 my-4 mx-3"></div>
                <button onclick="mudarAba('ativos')" id="btn-ativos" class="tab-btn w-full px-4 py-3 rounded-xl text-sm font-medium flex items-center gap-3 text-slate-600 dark:text-slate-400"><i class="ph-bold ph-check-circle text-lg"></i> Ativos</button>
                <button onclick="mudarAba('contratos')" id="btn-contratos" class="tab-btn w-full px-4 py-3 rounded-xl text-sm font-medium flex items-center gap-3 text-slate-600 dark:text-slate-400"><i class="ph-bold ph-file-text text-lg"></i> Contratos</button>
                <button onclick="mudarAba('notas')" id="btn-notas" class="tab-btn w-full px-4 py-3 rounded-xl text-sm font-medium flex items-center gap-3 text-slate-600 dark:text-slate-400"><i class="ph-bold ph-receipt text-lg"></i> Notas Fiscais</button>
                <div class="border-t border-slate-100 dark:border-slate-800 my-4 mx-3"></div>
                <button onclick="mudarAba('financeiro')" id="btn-financeiro" class="tab-btn w-full px-4 py-3 rounded-xl text-sm font-medium flex items-center gap-3 text-slate-600 dark:text-slate-400"><i class="ph-bold ph-briefcase text-lg"></i> Empresa</button>
                <button onclick="mudarAba('pessoal')" id="btn-pessoal" class="tab-btn w-full px-4 py-3 rounded-xl text-sm font-medium flex items-center gap-3 text-slate-600 dark:text-slate-400"><i class="ph-bold ph-house text-lg"></i> Pessoal</button>
            </nav>
            <div class="p-4 border-t dark:border-slate-800 shrink-0">
                <button onclick="mudarAba('perfil')" id="btn-perfil" class="tab-btn w-full mb-3 px-4 py-2.5 rounded-xl text-sm font-medium flex items-center gap-3 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all"><i class="ph-bold ph-user-gear text-lg"></i> Perfil</button>
                <div class="flex items-center justify-between gap-2">
                    <button onclick="togglePrivacy()" id="btn-eye-desktop" class="flex-1 p-2.5 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400"><i class="ph-bold ph-eye text-lg"></i></button>
                    <button onclick="toggleDarkMode()" class="flex-1 p-2.5 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400"><i class="ph-fill ph-moon text-lg"></i></button>
                    <button onclick="bloquearTela()" class="flex-1 p-2.5 rounded-lg bg-rose-50 text-rose-500"><i class="ph-bold ph-lock-key text-lg"></i></button>
                </div>
            </div>
        </aside>

        <div class="flex-1 flex flex-col h-full min-w-0 bg-slate-50 dark:bg-slate-950 relative overflow-hidden">
            <header class="xl:hidden bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 p-4 flex justify-between items-center shadow-sm">
                <button onclick="toggleSidebar()" class="p-2 bg-slate-100 dark:bg-slate-800 rounded-lg"><i class="ph-bold ph-list text-2xl"></i></button>
                <span class="font-bold text-lg dark:text-white">Gestor Pro</span>
                <button onclick="togglePrivacy()" id="btn-eye-mobile" class="p-2 text-slate-500"><i class="ph-bold ph-eye text-xl"></i></button>
            </header>

            <main class="flex-1 overflow-y-auto relative p-4 md:p-8" id="main-scroll-area">
                <div id="toast" class="hidden fixed bottom-6 right-6 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-xl z-[300] transition-all"></div>

                <!-- CRM -->
                <div id="view-crm" class="view-section fade-in space-y-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-white dark:bg-slate-900 p-5 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm relative overflow-hidden">
                            <p class="text-xs text-slate-500 font-bold uppercase mb-1">Em Negociação</p>
                            <h3 class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="crm-potencial">R$ 0,00</h3>
                        </div>
                        <div class="bg-white dark:bg-slate-900 p-5 rounded-2xl border-l-4 border-amber-400 shadow-sm dark:border-slate-800">
                            <p class="text-xs text-slate-500 font-bold uppercase mb-1">Sem Retorno</p>
                            <h3 class="text-2xl font-bold text-amber-600" id="crm-sem-retorno">R$ 0,00</h3>
                        </div>
                        <div class="bg-white dark:bg-slate-900 p-5 rounded-2xl border-l-4 border-emerald-500 shadow-sm dark:border-slate-800">
                            <p class="text-xs text-slate-500 font-bold uppercase mb-1">Ativos</p>
                            <h3 class="text-2xl font-bold text-emerald-600" id="crm-ativos">R$ 0,00</h3>
                        </div>
                        <div class="bg-white dark:bg-slate-900 p-5 rounded-2xl border-l-4 border-slate-400 shadow-sm dark:border-slate-800">
                            <p class="text-xs text-slate-500 font-bold uppercase mb-1">Perdidos</p>
                            <h3 class="text-2xl font-bold text-slate-600" id="crm-inativos">R$ 0,00</h3>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1">
                            <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl border dark:border-slate-800">
                                <h3 class="font-bold text-lg mb-5 flex items-center gap-2 dark:text-white"><i class="ph-bold ph-plus-circle text-blue-600"></i> Novo Lead</h3>
                                <form onsubmit="window.adicionarLead(event)" class="space-y-4">
                                    <input type="text" id="lead-nome" placeholder="Nome do Lead *" required class="w-full p-3 border rounded-xl dark:bg-slate-800 dark:text-white">
                                    <input type="text" id="lead-phone" placeholder="WhatsApp (99) 99999-9999" class="w-full p-3 border rounded-xl dark:bg-slate-800 dark:text-white">
                                    <input type="text" id="lead-empresa" placeholder="Empresa" class="w-full p-3 border rounded-xl dark:bg-slate-800 dark:text-white">
                                    <input type="number" id="lead-valor" step="0.01" placeholder="Valor do Contrato (R$)" class="w-full p-3 border rounded-xl dark:bg-slate-800 dark:text-white">
                                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">Salvar Lead</button>
                                </form>
                            </div>
                        </div>
                        <div class="lg:col-span-2 space-y-4" id="lista-leads"></div>
                    </div>
                </div>

                <!-- SCRIPTS -->
                <div id="view-scripts" class="view-section hidden fade-in">
                    <h3 class="font-bold text-lg text-slate-700 dark:text-white mb-6 flex items-center gap-2"><i class="ph-fill ph-chat-text text-indigo-500"></i> Scripts de Vendas</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1">
                            <div class="bg-white dark:bg-slate-900 p-5 rounded-2xl border dark:border-slate-800">
                                <form onsubmit="window.adicionarScript(event)" class="space-y-4">
                                    <input type="text" id="script-titulo" placeholder="Título do Script" required class="w-full p-3 border rounded-xl dark:bg-slate-800 dark:text-white">
                                    <div class="flex justify-between items-center"><span class="text-xs font-bold text-slate-400 uppercase">Conteúdo</span><button type="button" onclick="window.gerarScriptIA()" class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded font-bold hover:bg-purple-200"><i class="ph-bold ph-sparkle"></i> Gerar com IA</button></div>
                                    <textarea id="script-texto" rows="8" class="w-full p-3 border rounded-xl dark:bg-slate-800 dark:text-white"></textarea>
                                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">Criar Script</button>
                                </form>
                            </div>
                        </div>
                        <div class="lg:col-span-2 space-y-4" id="lista-scripts"></div>
                    </div>
                </div>

                <!-- CONTROLE DE CONTAS -->
                <div id="view-contas" class="view-section hidden fade-in space-y-6">
                    <h3 class="font-bold text-lg dark:text-white mb-6 flex items-center gap-2"><i class="ph-fill ph-list-checks text-purple-500"></i> Controle de Parcelas</h3>
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                        <div>
                            <h4 class="font-bold text-slate-500 mb-4 border-b pb-2 uppercase text-xs tracking-wider">Parcelamentos Empresa</h4>
                            <div id="lista-contas-pj" class="space-y-4"></div>
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-500 mb-4 border-b pb-2 uppercase text-xs tracking-wider">Parcelamentos Pessoais</h4>
                            <div id="lista-contas-pf" class="space-y-4"></div>
                        </div>
                    </div>
                </div>

                <!-- METAS -->
                <div id="view-metas" class="view-section hidden fade-in">
                    <h3 class="font-bold text-lg dark:text-white mb-6 flex items-center gap-2"><i class="ph-fill ph-target text-rose-500"></i> Meus Objetivos</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1">
                            <div class="bg-white dark:bg-slate-900 p-5 rounded-2xl border dark:border-slate-800">
                                <form onsubmit="window.adicionarMeta(event)" class="space-y-4">
                                    <input type="text" id="meta-titulo" placeholder="Objetivo (Ex: Novo MacBook)" required class="w-full p-3 border rounded-xl dark:bg-slate-800 dark:text-white">
                                    <input type="number" id="meta-valor" step="0.01" placeholder="Valor Alvo (R$)" required class="w-full p-3 border rounded-xl dark:bg-slate-800 dark:text-white font-bold">
                                    <button type="submit" class="w-full bg-rose-600 text-white py-3 rounded-xl font-bold">Criar Meta</button>
                                </form>
                            </div>
                        </div>
                        <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4" id="lista-metas"></div>
                    </div>
                </div>

                <!-- NOTIFICAÇÕES (ATUALIZADA) -->
                <div id="view-notificacoes" class="view-section hidden fade-in">
                    <h3 class="font-bold text-lg dark:text-white mb-6 flex items-center gap-2"><i class="ph-fill ph-bell text-blue-500"></i> Novidades & Histórico</h3>
                    <div class="relative pl-6 border-l-2 border-slate-200 dark:border-slate-700 space-y-8">
                        
                        <div class="relative">
                            <div class="absolute -left-[29px] top-0 bg-white dark:bg-slate-900 border-4 border-emerald-500 w-4 h-4 rounded-full"></div>
                            <div class="mb-1 text-[10px] font-bold text-emerald-600 dark:text-emerald-400 uppercase tracking-widest">Versão 2.3 • 26/01/2026 - 12:15</div>
                            <h4 class="text-lg font-bold text-slate-800 dark:text-white mb-2">Registo de Tempo Preciso</h4>
                            <p class="text-slate-500 text-sm leading-relaxed">Implementamos carimbos de data e hora reais nas notas de lançamento para permitir um melhor rastreio da evolução do sistema.</p>
                        </div>

                        <div class="relative">
                            <div class="absolute -left-[29px] top-0 bg-white dark:bg-slate-900 border-4 border-blue-500 w-4 h-4 rounded-full"></div>
                            <div class="mb-1 text-[10px] font-bold text-blue-600 dark:text-blue-400 uppercase tracking-widest">Versão 2.2 • 25/01/2026 - 09:45</div>
                            <h4 class="text-lg font-bold text-slate-800 dark:text-white mb-2">Integração Direta com WhatsApp</h4>
                            <p class="text-slate-500 text-sm leading-relaxed">Agora pode iniciar conversas com leads diretamente do Pipeline clicando no ícone do WhatsApp.</p>
                        </div>

                        <div class="relative">
                            <div class="absolute -left-[29px] top-0 bg-white dark:bg-slate-900 border-4 border-purple-500 w-4 h-4 rounded-full"></div>
                            <div class="mb-1 text-[10px] font-bold text-purple-600 dark:text-purple-400 uppercase tracking-widest">Versão 2.1 • 15/01/2026 - 16:20</div>
                            <h4 class="text-lg font-bold text-slate-800 dark:text-white mb-2">Controle de Saúde Financeira</h4>
                            <p class="text-slate-500 text-sm leading-relaxed">Adicionada barra de saúde financeira que calcula automaticamente a sua margem de lucro e reserva de emergência.</p>
                        </div>

                    </div>
                </div>

                <!-- FINANCEIRO PJ -->
                <div id="view-financeiro" class="view-section hidden fade-in space-y-6">
                    <div class="flex items-center justify-center gap-6 mb-4">
                        <button onclick="window.mudarMes(-1)" class="p-2 hover:bg-slate-200 dark:hover:bg-slate-800 rounded-full transition-all"><i class="ph-bold ph-caret-left text-xl"></i></button>
                        <h3 id="label-mes-ano" class="text-xl font-bold capitalize text-slate-800 dark:text-white w-48 text-center">...</h3>
                        <button onclick="window.mudarMes(1)" class="p-2 hover:bg-slate-200 dark:hover:bg-slate-800 rounded-full transition-all"><i class="ph-bold ph-caret-right text-xl"></i></button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white dark:bg-slate-900 p-5 rounded-2xl border-l-4 border-emerald-500 shadow-sm"><p class="text-xs font-bold text-emerald-600 uppercase">Receita</p><h3 class="text-2xl font-bold dark:text-white" id="pj-receita">R$ 0,00</h3></div>
                        <div class="bg-white dark:bg-slate-900 p-5 rounded-2xl border-l-4 border-rose-500 shadow-sm"><p class="text-xs font-bold text-rose-600 uppercase">Despesas</p><h3 class="text-2xl font-bold dark:text-white" id="pj-despesa">R$ 0,00</h3></div>
                        <div class="bg-white dark:bg-slate-900 p-5 rounded-2xl border-l-4 border-blue-500 shadow-sm"><p class="text-xs font-bold text-blue-600 uppercase">Saldo</p><h3 class="text-2xl font-bold dark:text-white" id="pj-saldo">R$ 0,00</h3></div>
                    </div>

                    <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl border dark:border-slate-800 shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold dark:text-white flex items-center gap-2"><i class="ph-fill ph-heartbeat text-rose-500"></i> Saúde Financeira da Empresa</h3>
                            <div class="flex items-center gap-2 bg-slate-50 dark:bg-slate-800 p-1 rounded-lg">
                                <span class="text-[10px] font-bold text-slate-400 uppercase ml-2">Retenção:</span>
                                <input type="number" id="input-percentual-reserva" value="20" class="w-10 bg-transparent text-center font-bold outline-none dark:text-white" onchange="window.salvarConfigFinanceira()">
                                <span class="font-bold text-slate-400 mr-2">%</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                            <div>
                                <div class="flex justify-between mb-2"><span class="text-xs font-bold text-slate-500" id="label-saude-status">Excelente</span><span class="text-xs font-bold text-slate-400" id="pj-margin">0% Margem</span></div>
                                <div class="health-bar-container w-full h-4 bg-slate-100 dark:bg-slate-800 rounded-full"><div id="bar-saude-fill" class="health-bar-fill h-full bg-emerald-500 rounded-full" style="width: 0%"></div></div>
                            </div>
                            <div class="bg-indigo-50 dark:bg-indigo-900/10 p-4 rounded-xl border border-indigo-100 dark:border-indigo-900/30 flex justify-between items-center">
                                <div><p class="text-[10px] font-bold text-indigo-500 uppercase">Disponível para Pró-Labore</p><h4 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400" id="val-meu-salario">R$ 0,00</h4></div>
                                <div class="text-right"><p class="text-[10px] font-bold text-slate-400 uppercase">Reserva (Meta)</p><h4 class="text-sm font-bold text-slate-600 dark:text-slate-300" id="val-reserva-empresa">R$ 0,00</h4></div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white dark:bg-slate-900 p-5 rounded-2xl border dark:border-slate-800 h-80"><canvas id="grafico-pj"></canvas></div>
                        <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl border dark:border-slate-800 shadow-sm h-fit">
                            <h3 class="font-bold dark:text-white mb-4">Lançar PJ</h3>
                            <form onsubmit="window.adicionarTransacao(event, 'pj')" class="space-y-4">
                                <div class="flex gap-2"><label class="flex-1 cursor-pointer"><input type="radio" name="pj-tipo" value="entrada" checked class="hidden peer"><div class="p-2 text-center rounded-lg border peer-checked:bg-emerald-100 peer-checked:text-emerald-700 text-sm font-bold">Entrada</div></label><label class="flex-1 cursor-pointer"><input type="radio" name="pj-tipo" value="saida" class="hidden peer"><div class="p-2 text-center rounded-lg border peer-checked:bg-rose-100 peer-checked:text-rose-700 text-sm font-bold">Saída</div></label></div>
                                <input type="text" id="pj-desc" placeholder="Descrição" required class="w-full p-3 border rounded-xl dark:bg-slate-800 dark:text-white">
                                <input type="number" id="pj-valor" step="0.01" placeholder="Valor (R$)" required class="w-full p-3 border rounded-xl dark:bg-slate-800 dark:text-white font-bold">
                                <div class="grid grid-cols-2 gap-2">
                                    <select id="pj-modalidade" onchange="window.toggleModalidade('pj')" class="p-3 border rounded-xl dark:bg-slate-800 dark:text-white text-xs"><option value="unico">Único</option><option value="parcelado">Parcelado</option></select>
                                    <input type="date" id="pj-data" class="p-3 border rounded-xl dark:bg-slate-800 dark:text-white text-xs">
                                </div>
                                <div id="pj-parcelas-container" class="hidden"><input type="number" id="pj-parcelas" value="12" class="w-full p-3 border rounded-xl dark:bg-slate-800 dark:text-white"></div>
                                <button type="submit" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold">Confirmar</button>
                            </form>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-slate-900 rounded-2xl border dark:border-slate-800 overflow-hidden"><table class="w-full text-left text-sm"><tbody id="lista-transacoes-pj"></tbody></table></div>
                </div>

                <!-- FINANCEIRO PF (Omissão Restaurada) -->
                <div id="view-pessoal" class="view-section hidden fade-in space-y-6">
                    <!-- Similar structure to PJ, omitted for brevity but logic remains in JS -->
                    <div id="pf-header" class="text-center font-bold text-xl dark:text-white mb-6">Finanças Pessoais</div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white dark:bg-slate-900 p-5 rounded-2xl border-l-4 border-blue-500 shadow-sm"><p class="text-xs font-bold text-blue-600 uppercase">Ganhos</p><h3 class="text-2xl font-bold dark:text-white" id="pf-receita">R$ 0,00</h3></div>
                        <div class="bg-white dark:bg-slate-900 p-5 rounded-2xl border-l-4 border-orange-500 shadow-sm"><p class="text-xs font-bold text-orange-600 uppercase">Gastos</p><h3 class="text-2xl font-bold dark:text-white" id="pf-despesa">R$ 0,00</h3></div>
                        <div class="bg-white dark:bg-slate-900 p-5 rounded-2xl border-l-4 border-slate-500 shadow-sm"><p class="text-xs font-bold text-slate-500 uppercase">Saldo</p><h3 class="text-2xl font-bold dark:text-white" id="pf-saldo">R$ 0,00</h3></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white dark:bg-slate-900 p-5 rounded-2xl border dark:border-slate-800 h-80"><canvas id="grafico-pf"></canvas></div>
                        <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl border dark:border-slate-800 shadow-sm h-fit">
                            <h3 class="font-bold dark:text-white mb-4">Lançar PF</h3>
                            <form onsubmit="window.adicionarTransacao(event, 'pf')" class="space-y-4">
                                <div class="flex gap-2"><label class="flex-1 cursor-pointer"><input type="radio" name="pf-tipo" value="entrada" checked class="hidden peer"><div class="p-2 text-center rounded-lg border peer-checked:bg-blue-100 peer-checked:text-blue-700 text-sm font-bold">Ganho</div></label><label class="flex-1 cursor-pointer"><input type="radio" name="pf-tipo" value="saida" class="hidden peer"><div class="p-2 text-center rounded-lg border peer-checked:bg-orange-100 peer-checked:text-orange-700 text-sm font-bold">Gasto</div></label></div>
                                <input type="text" id="pf-desc" placeholder="Descrição" required class="w-full p-3 border rounded-xl dark:bg-slate-800 dark:text-white">
                                <input type="number" id="pf-valor" step="0.01" placeholder="Valor (R$)" required class="w-full p-3 border rounded-xl dark:bg-slate-800 dark:text-white font-bold">
                                <div class="grid grid-cols-2 gap-2"><input type="date" id="pf-data" class="p-3 border rounded-xl dark:bg-slate-800 dark:text-white text-xs w-full col-span-2"></div>
                                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">Registrar</button>
                            </form>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-slate-900 rounded-2xl border dark:border-slate-800 overflow-hidden"><table class="w-full text-left text-sm"><tbody id="lista-transacoes-pf"></tbody></table></div>
                </div>

                <!-- PERFIL -->
                <div id="view-perfil" class="view-section hidden fade-in">
                    <h3 class="font-bold text-lg dark:text-white mb-6 flex items-center gap-2"><i class="ph-fill ph-user-gear text-blue-600"></i> Gestão de Perfil</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="md:col-span-1">
                            <div class="bg-white dark:bg-slate-900 p-8 rounded-3xl border dark:border-slate-800 text-center">
                                <div class="relative w-32 h-32 mx-auto mb-4 rounded-full bg-slate-100 dark:bg-slate-800 overflow-hidden group border-4 border-white shadow-lg">
                                    <img id="profile-preview" src="" alt="" class="w-full h-full object-cover hidden">
                                    <i id="profile-placeholder" class="ph-fill ph-user text-4xl text-slate-300 flex items-center justify-center h-full"></i>
                                    <label for="profile-upload" class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer text-white text-[10px] font-bold">ALTERAR</label>
                                </div>
                                <input type="file" id="profile-upload" accept="image/*" class="hidden" onchange="window.uploadProfileImage(this)">
                                <h4 class="font-bold dark:text-white" id="display-company">Empresa</h4>
                                <p class="text-sm text-slate-500" id="display-name">Utilizador</p>
                            </div>
                        </div>
                        <div class="md:col-span-2 bg-white dark:bg-slate-900 p-8 rounded-3xl border dark:border-slate-800">
                            <form onsubmit="window.salvarPerfil(event)" class="space-y-4">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <input type="text" id="prof-company" placeholder="Nome da Empresa" class="p-3 border rounded-xl dark:bg-slate-800 dark:text-white">
                                    <input type="text" id="prof-name" placeholder="Seu Nome" class="p-3 border rounded-xl dark:bg-slate-800 dark:text-white">
                                    <input type="email" id="prof-email" placeholder="Email" class="p-3 border rounded-xl dark:bg-slate-800 dark:text-white">
                                    <input type="text" id="prof-phone" placeholder="Telefone" class="p-3 border rounded-xl dark:bg-slate-800 dark:text-white">
                                </div>
                                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">Salvar Alterações</button>
                            </form>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- MODAL CONFIG -->
    <div id="modal-config" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-900 rounded-2xl w-full max-w-md p-6 border dark:border-slate-700">
            <h3 class="text-xl font-bold dark:text-white mb-4">Configurações Gerais</h3>
            <label class="block text-xs font-bold text-slate-500 mb-1">CHAVE API GEMINI (IA)</label>
            <input type="password" id="input-api-key" class="w-full p-3 border rounded-xl mb-6 dark:bg-slate-800 dark:text-white">
            <button onclick="salvarConfig()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold">Salvar Ajustes</button>
            <button onclick="fecharConfig()" class="w-full text-slate-400 mt-2 text-sm">Cancelar</button>
        </div>
    </div>

    <!-- LÓGICA DE DADOS (FIREBASE MODULE) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCv76c4hOVDZ-_lrGqemSxgXzuqb3Ezvcw",
            authDomain: "gestorpro-saas-b69c8.firebaseapp.com",
            projectId: "gestorpro-saas-b69c8",
            storageBucket: "gestorpro-saas-b69c8.firebasestorage.app",
            messagingSenderId: "252748859780",
            appId: "1:252748859780:web:7eb87073ef72435bf1f5d1"
        };

        let db = null, auth = null, currentUser = null;

        if (firebaseConfig.apiKey) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                signInAnonymously(auth).catch(e => console.warn("Erro Auth:", e));
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user; window.isOnline = true;
                        updateStatus(true); setupCloudListeners(user.uid);
                    }
                });
            } catch (e) { console.warn("Modo Offline Ativado"); }
        }

        function updateStatus(online) {
            const el = document.getElementById('connection-status');
            if(el) el.innerHTML = online ? '<span class="text-emerald-500"><i class="ph-fill ph-cloud-check"></i> Sincronizado</span>' : 'Offline';
        }

        function setupCloudListeners(uid) {
            const map = { 'leads': 'leads', 'scripts': 'scripts', 'notas': 'notas', 'transacoes_pj': 'pj', 'transacoes_pf': 'pf', 'metas': 'metas' };
            Object.keys(map).forEach(col => {
                onSnapshot(collection(db, 'users', uid, col), (snap) => {
                    window.DB[map[col]] = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    window.renderizar();
                });
            });
            onSnapshot(doc(db, 'users', uid, 'config', 'profile'), (snap) => {
                if(snap.exists()) { window.DB.profile = snap.data(); window.carregarPerfil(); }
            });
            onSnapshot(doc(db, 'users', uid, 'config', 'settings'), (snap) => {
                if(snap.exists()) { window.DB.settings = snap.data(); window.renderizar(); }
            });
        }

        // Funções de Escrita no Banco (Restauradas)
        window.adicionarLead = async (e) => {
            e.preventDefault();
            const data = {
                nome: document.getElementById('lead-nome').value,
                telefone: document.getElementById('lead-phone').value,
                empresa: document.getElementById('lead-empresa').value,
                valor: parseFloat(document.getElementById('lead-valor').value) || 0,
                status: 'negociacao', createdAt: Date.now()
            };
            if(window.isOnline && currentUser) await addDoc(collection(db, 'users', currentUser.uid, 'leads'), data);
            else { window.DB.leads.push({id: String(Date.now()), ...data}); window.saveLocal(); }
            e.target.reset(); window.mostrarToast('Lead guardado!');
        };

        window.alterarStatusLead = async (id, ns) => {
            if(window.isOnline && currentUser) await updateDoc(doc(db, 'users', currentUser.uid, 'leads', id), {status: ns});
            else { const l = window.DB.leads.find(x => x.id === id); if(l) l.status = ns; window.saveLocal(); }
        };

        window.excluirLead = async (id) => {
            if(!confirm('Deseja eliminar este lead?')) return;
            if(window.isOnline && currentUser) await deleteDoc(doc(db, 'users', currentUser.uid, 'leads', id));
            else { window.DB.leads = window.DB.leads.filter(x => x.id !== id); window.saveLocal(); }
        };

        window.adicionarTransacao = async (e, tipo) => {
            e.preventDefault();
            const op = document.querySelector(`input[name="${tipo}-tipo"]:checked`).value;
            const desc = document.getElementById(`${tipo}-desc`).value;
            const v = parseFloat(document.getElementById(`${tipo}-valor`).value) || 0;
            const mod = tipo === 'pj' ? document.getElementById(`${tipo}-modalidade`).value : 'unico';
            const dataStr = document.getElementById(`${tipo}-data`).value || new Date().toISOString().split('T')[0];
            const dateParts = dataStr.split('-');
            const formattedDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;

            const loop = mod === 'parcelado' ? (parseInt(document.getElementById('pj-parcelas').value) || 1) : 1;
            const groupId = String(Date.now());

            for(let i=0; i<loop; i++) {
                const tData = { op, desc, valor: v, data: formattedDate, modalidade: mod, groupId, createdAt: Date.now()+i };
                if(window.isOnline && currentUser) await addDoc(collection(db, 'users', currentUser.uid, `transacoes_${tipo}`), tData);
                else window.DB[tipo].push({id: String(Date.now()+i), ...tData});
            }
            if(!window.isOnline) window.saveLocal();
            e.target.reset(); window.mostrarToast('Movimentação registada!');
        };

        window.excluirTransacao = async (id, tipo) => {
            if(window.isOnline && currentUser) await deleteDoc(doc(db, 'users', currentUser.uid, `transacoes_${tipo}`, id));
            else { window.DB[tipo] = window.DB[tipo].filter(x => x.id !== id); window.saveLocal(); }
        };

        window.salvarPerfil = async (e) => {
            e.preventDefault();
            const data = { 
                company: document.getElementById('prof-company').value, 
                name: document.getElementById('prof-name').value,
                email: document.getElementById('prof-email').value,
                phone: document.getElementById('prof-phone').value
            };
            const updated = { ...(window.DB.profile || {}), ...data };
            if(window.isOnline && currentUser) await setDoc(doc(db, 'users', currentUser.uid, 'config', 'profile'), updated);
            else { window.DB.profile = updated; window.saveLocal(); }
            window.mostrarToast('Perfil atualizado!');
        };
    </script>

    <!-- UI & RENDER SCRIPT (Restaurado e Completo) -->
    <script>
        const SYSTEM_SECRET = "@uroraSystem@2024";
        const CURRENT_VERSION_ID = '2.3';
        let chartPJ, chartPF;

        function renderizar() {
            renderCRM();
            renderScripts();
            renderFin('pj');
            renderFin('pf');
            renderMetas();
            carregarPerfil();
        }

        function renderCRM() {
            const list = document.getElementById('lista-leads'); if(!list) return;
            list.innerHTML = '';
            
            // Lógica de Soma de Totais
            const neg = window.DB.leads.filter(l => l.status === 'negociacao');
            const ati = window.DB.leads.filter(l => l.status === 'ganho');
            const sem = window.DB.leads.filter(l => l.status === 'sem_retorno');
            const ina = window.DB.leads.filter(l => ['perdido','inativo'].includes(l.status));

            document.getElementById('crm-potencial').innerText = window.formatMoney(neg.reduce((a,b)=>a+b.valor, 0));
            document.getElementById('crm-ativos').innerText = window.formatMoney(ati.reduce((a,b)=>a+b.valor, 0));
            document.getElementById('crm-sem-retorno').innerText = window.formatMoney(sem.reduce((a,b)=>a+b.valor, 0));
            document.getElementById('crm-inativos').innerText = window.formatMoney(ina.reduce((a,b)=>a+b.valor, 0));

            window.DB.leads.filter(l => l.status === 'negociacao').forEach(l => {
                let wp = l.telefone ? `<a href="https://wa.me/55${l.telefone.replace(/\D/g,'')}" target="_blank" class="text-emerald-500 p-2 bg-emerald-50 dark:bg-emerald-900/20 rounded-lg"><i class="ph-bold ph-whatsapp-logo text-xl"></i></a>` : '';
                list.innerHTML += `
                    <div class="bg-white dark:bg-slate-900 p-4 rounded-xl border dark:border-slate-800 shadow-sm flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="flex-1">
                            <div class="font-bold dark:text-white">${l.nome}</div>
                            <div class="text-xs text-slate-500">${l.empresa || 'Cliente Particular'} • ${window.formatMoney(l.valor)}</div>
                        </div>
                        <div class="flex items-center gap-2">
                            ${wp}
                            <button onclick="window.alterarStatusLead('${l.id}', 'ganho')" class="p-2 bg-emerald-500 text-white rounded-lg"><i class="ph-bold ph-check"></i></button>
                            <button onclick="window.alterarStatusLead('${l.id}', 'sem_retorno')" class="p-2 bg-amber-500 text-white rounded-lg"><i class="ph-bold ph-clock"></i></button>
                            <button onclick="window.excluirLead('${l.id}')" class="p-2 text-slate-400"><i class="ph-bold ph-trash"></i></button>
                        </div>
                    </div>
                `;
            });
        }

        function renderFin(type) {
            const list = window.DB[type];
            const m = window.viewDate.getMonth(), y = window.viewDate.getFullYear();
            const label = document.getElementById(type === 'pj' ? 'label-mes-ano' : 'label-mes-ano-pf');
            if(label) label.innerText = window.viewDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });

            const filtered = list.filter(t => {
                const p = t.data.split('/');
                const d = new Date(p[2], p[1]-1, p[0]);
                return d.getMonth() === m && d.getFullYear() === y;
            });

            const ent = filtered.filter(t => t.op === 'entrada').reduce((a,b)=>a+b.valor, 0);
            const sai = filtered.filter(t => t.op === 'saida').reduce((a,b)=>a+b.valor, 0);
            const sal = ent - sai;

            const recEl = document.getElementById(`${type}-receita`); if(recEl) recEl.innerText = window.formatMoney(ent);
            const desEl = document.getElementById(`${type}-despesa`); if(desEl) desEl.innerText = window.formatMoney(sai);
            const salEl = document.getElementById(`${type}-saldo`); if(salEl) { salEl.innerText = window.formatMoney(sal); salEl.className = `text-2xl font-bold ${sal>=0?'dark:text-white':'text-rose-500'}`; }

            // Lógica de Saúde Financeira (Exclusiva PJ)
            if(type === 'pj') {
                const rate = window.DB.settings.reinvestRate || 20;
                const margin = ent > 0 ? (sal / ent) * 100 : 0;
                const reserve = sal > 0 ? sal * (rate/100) : 0;
                const salary = sal > 0 ? sal - reserve : 0;

                document.getElementById('pj-margin').innerText = `${margin.toFixed(0)}% Margem`;
                document.getElementById('val-meu-salario').innerText = window.formatMoney(salary);
                document.getElementById('val-reserva-empresa').innerText = window.formatMoney(reserve);
                
                const bar = document.getElementById('bar-saude-fill');
                bar.style.width = `${Math.min(Math.max(margin*2, 5), 100)}%`;
                bar.className = `health-bar-fill h-full rounded-full ${margin > 30 ? 'bg-emerald-500' : (margin > 10 ? 'bg-amber-500' : 'bg-rose-500')}`;
                document.getElementById('label-saude-status').innerText = margin > 30 ? 'Saudável' : (margin > 0 ? 'Alerta' : 'Crítico');
            }

            const table = document.getElementById(`lista-transacoes-${type}`);
            if(table) {
                table.innerHTML = '';
                filtered.sort((a,b) => b.createdAt - a.createdAt).forEach(t => {
                    table.innerHTML += `<tr class="border-b dark:border-slate-800"><td class="p-4 font-medium dark:text-white">${t.desc} <span class="block text-[10px] text-slate-400 font-normal">${t.data}</span></td><td class="p-4 text-right font-bold ${t.op==='entrada'?'text-emerald-500':'text-rose-500'}">${window.formatMoney(t.valor)}</td><td class="p-4 text-right"><button onclick="window.excluirTransacao('${t.id}', '${type}')" class="text-slate-300 hover:text-rose-500"><i class="ph-bold ph-trash"></i></button></td></tr>`;
                });
            }
            updateChart(type, ent, sai);
        }

        function updateChart(type, ent, sai) {
            const ctx = document.getElementById(`grafico-${type}`); if(!ctx) return;
            if(type==='pj' && chartPJ) chartPJ.destroy();
            if(type==='pf' && chartPF) chartPF.destroy();
            const config = { type: 'doughnut', data: { labels: ['Entradas', 'Saídas'], datasets: [{ data: [ent, sai], backgroundColor: [type==='pj'?'#10b981':'#3b82f6', '#f43f5e'] }] }, options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, color: '#94a3b8' } } } } };
            if(type==='pj') chartPJ = new Chart(ctx, config); else chartPF = new Chart(ctx, config);
        }

        function renderScripts() {
            const list = document.getElementById('lista-scripts'); if(!list) return;
            list.innerHTML = '';
            window.DB.scripts.forEach(s => {
                list.innerHTML += `<div class="bg-white dark:bg-slate-900 p-5 rounded-2xl border dark:border-slate-800">
                    <div class="flex justify-between items-start mb-2"><h4 class="font-bold dark:text-white">${s.titulo}</h4><button onclick="copiarScript(\`${s.texto.replace(/`/g, '\\`')}\`)" class="text-indigo-500"><i class="ph-bold ph-copy text-xl"></i></button></div>
                    <pre class="text-xs text-slate-500 whitespace-pre-wrap font-sans">${s.texto}</pre>
                </div>`;
            });
        }

        function renderMetas() {
            const list = document.getElementById('lista-metas'); if(!list) return;
            list.innerHTML = '';
            window.DB.metas.forEach(m => {
                const perc = Math.min(100, Math.round(((m.atual || 0) / m.alvo) * 100));
                list.innerHTML += `<div class="bg-white dark:bg-slate-900 p-5 rounded-2xl border dark:border-slate-800">
                    <div class="flex justify-between mb-2"><span class="font-bold dark:text-white">${m.titulo}</span><span class="text-xs font-bold text-blue-500">${perc}%</span></div>
                    <div class="w-full bg-slate-100 dark:bg-slate-800 h-2 rounded-full mb-3"><div class="h-full bg-blue-500 rounded-full" style="width: ${perc}%"></div></div>
                    <div class="flex justify-between items-center"><span class="text-xs text-slate-400">${window.formatMoney(m.atual)} / ${window.formatMoney(m.alvo)}</span><button onclick="window.atualizarMeta('${m.id}')" class="text-xs bg-slate-100 dark:bg-slate-800 p-1 px-2 rounded font-bold dark:text-white">+ Adicionar</button></div>
                </div>`;
            });
        }

        // Funções UI Auxiliares
        function carregarPerfil() {
            const p = window.DB.profile || {};
            document.getElementById('header-name').innerText = p.company || p.name || 'Gestor Pro';
            document.getElementById('display-company').innerText = p.company || 'Sua Empresa';
            document.getElementById('display-name').innerText = p.name || 'Utilizador';
            if(p.image) {
                document.getElementById('profile-preview').src = p.image;
                document.getElementById('profile-preview').classList.remove('hidden');
                document.getElementById('profile-placeholder').classList.add('hidden');
                document.getElementById('header-avatar').innerHTML = `<img src="${p.image}" class="w-full h-full object-cover">`;
            }
        }
        window.carregarPerfil = carregarPerfil;

        function mudarAba(aba) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${aba}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-600', 'text-white', 'shadow-md');
                btn.classList.add('text-slate-600', 'dark:text-slate-400');
            });
            const activeBtn = document.getElementById(`btn-${aba}`);
            activeBtn.classList.add('active', 'bg-blue-600', 'text-white', 'shadow-md');
            activeBtn.classList.remove('text-slate-600', 'dark:text-slate-400');
            if (aba === 'notificacoes') { localStorage.setItem('gestor_last_news_id', CURRENT_VERSION_ID); checkNotifications(); }
            renderizar();
        }

        function checkNotifications() {
            const last = localStorage.getItem('gestor_last_news_id');
            const badge = document.getElementById('notif-badge');
            if (last !== CURRENT_VERSION_ID && badge) badge.classList.remove('hidden');
            else if (badge) badge.classList.add('hidden');
        }

        function togglePrivacy() { window.showValues = !window.showValues; localStorage.setItem('gestor_show_values', window.showValues); renderizar(); }
        function toggleDarkMode() { document.documentElement.classList.toggle('dark'); localStorage.setItem('gestor_theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('-translate-x-full'); }
        function mostrarToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 3000); }
        function copiarScript(t) { navigator.clipboard.writeText(t); mostrarToast('Copiado para a área de transferência!'); }
        function fecharConfig() { document.getElementById('modal-config').classList.add('hidden'); }
        function abrirConfig() { document.getElementById('modal-config').classList.remove('hidden'); }
        function salvarConfig() { localStorage.setItem('gemini_api_key', document.getElementById('input-api-key').value); fecharConfig(); mostrarToast('Configurações salvas!'); }

        window.mudarMes = function(delta) { window.viewDate.setMonth(window.viewDate.getMonth() + delta); renderizar(); };

        window.saveLocal = function() {
            localStorage.setItem('gestor_leads', JSON.stringify(window.DB.leads));
            localStorage.setItem('gestor_scripts', JSON.stringify(window.DB.scripts));
            localStorage.setItem('gestor_pj', JSON.stringify(window.DB.pj));
            localStorage.setItem('gestor_pf', JSON.stringify(window.DB.pf));
            localStorage.setItem('gestor_metas', JSON.stringify(window.DB.metas));
            localStorage.setItem('gestor_profile', JSON.stringify(window.DB.profile));
            localStorage.setItem('gestor_settings', JSON.stringify(window.DB.settings));
            renderizar();
        };

        window.uploadProfileImage = (input) => {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    window.DB.profile.image = e.target.result;
                    window.saveLocal();
                    carregarPerfil();
                };
                reader.readAsDataURL(file);
            }
        };

        window.bloquearTela = function() { 
            document.getElementById('login-overlay').classList.remove('hidden'); 
            document.getElementById('app-content').classList.add('blur-content'); 
        };

        function checkLicense() {
            const lic = JSON.parse(localStorage.getItem('gestor_license'));
            if(!lic) { document.getElementById('license-overlay').classList.remove('hidden'); return; }
            document.getElementById('license-overlay').classList.add('hidden');
            checkAuth();
        }

        function checkAuth() {
            if(!localStorage.getItem('gestor_auth')) { 
                document.getElementById('login-title').innerText="Criar Acesso"; 
                document.getElementById('confirm-pass-container').classList.remove('hidden'); 
            }
            document.getElementById('login-overlay').classList.remove('hidden');
            checkNotifications();
        }

        function handleActivation(e) {
            e.preventDefault();
            const n=document.getElementById('lic-name').value, d=document.getElementById('lic-date').value, k=document.getElementById('lic-key').value;
            // Lógica de verificação simples (substitua pelo seu HASH real se necessário)
            if(n && d && k) {
                localStorage.setItem('gestor_license', JSON.stringify({name:n, date:d, key:k}));
                location.reload();
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const p=document.getElementById('login-pass').value;
            const s=localStorage.getItem('gestor_auth');
            if(!s) {
                const cp=document.getElementById('login-pass-confirm').value;
                if(p.length < 4 || p !== cp) return alert("Erro na senha!");
                localStorage.setItem('gestor_auth', CryptoJS.SHA256(p).toString());
                unlock();
            } else {
                if(CryptoJS.SHA256(p).toString() === s) unlock();
                else alert("Senha incorreta!");
            }
        }

        function unlock() {
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('app-content').classList.remove('blur-content');
            renderizar();
        }

        function emergencyReset() { if(confirm("Apagar todos os dados locais?")) { localStorage.clear(); location.reload(); } }

        window.onload = checkLicense;
    </script>
</body>
</html>
